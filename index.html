<html>
  <body>
  <font size=4><div id="where"></div></font>
  <img id="picture" src="">
  <font size=3><div id="what"></div></font>
  <font size=3><div id="inventory"></div></font>
  <font size=3><div id="next"></div></font>
  <font size=3><div id="cookieField"></div></font>
  <font size=3><div id="otherUsers"></div></font>
  <script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
  <script>
    $(function() {
      $("#where").html("booting...");
      //where = "strong-hall";
      var where;
      var cookieDate;
      
      function getCookie(cookieName){
          var name = cookieName + "=";
          var cookie = document.cookie;
          while(cookie.charAt(0) == ' '){
              cookie = cookie.substring(1);
          }
          if(cookie.indexOf(name) != -1){
              return cookie.substring(name.length, cookie.length);
          }
      }
      
      function checkCookie(){
          cookieDate = getCookie("EECS581");
          if(cookieDate == undefined){
              cookieDate = new Date().getTime();
              /*
              var expireDate = new Date().setTime(cookieDate.getTime() +
                      365*24*60*60*1000);
              var expires = "expires=" + expireDate.toUTCString();*/
              document.cookie = "EECS581=" + cookieDate;
          }
      }

      checkCookie();
      console.log(cookieDate);
      $.get("/" + cookieDate, function(response){
          console.log("hwat");
          where = "strong-hall";  
          $("#cookieField").html("what");
      });

      setInterval(function refresh() {
        $.get("/" + where + "/" + cookieDate, function (response) {
           var data = response.loc;
           $("#where").html(data.text);
           $("#picture").attr("src","images/" + data.where);
           if (data.what == undefined || data.what.length == 0) {
              $("#what").html("");
           } else {
              $("#what").html("You can see: ");
              for(var i in data.what) {
                var item = data.what[i];
                $("#what").append(item);
                button = $("<button/>");
                button.text("Take " + item);
                (function(button,where,item) {
                  button.click(function() {
                    $.ajax("/" + where + "/" + item + "/" + cookieDate,
                        { success : refresh
                        , type : "DELETE"
                        }
                    );
                    refresh();
                  });
                })(button,where,item);
                $("#what").append(button);
              }
          }

          $("#next").html("");
          for(var i in data.next) {
            button = $("<button/>");
            button.text("Go " + i);
            (function(button,dest) {
              button.click(function() {
                where = dest;
                refresh();
              });
            })(button,data.next[i]);
            $("#next").append(button);
          }
          
          $("#otherUsers").html("");
          for(var i in response.users) {
            div = $("<div></div>");
            button = $("<button/>");
            button.text("User: " + i);
            div.append(button);
            //$.get("/inventory/" + response.users[i], function (usersItems) {
            var usersItems = response.users[i].inventory; 
            if(usersItems != undefined && usersItems.length != 0){
             for(var j in usersItems) {
                button2 = $("<button/>");
                button2.text("Steal: " + usersItems[j]);
                (function(button, myid, otherid, item) {
                 button.click(function() {
                    $.ajax("/" + where + "/" + item + "/" + otherid + "/" + myid,
                            { success : refresh
                            , type : "DELETE"
                            }
                        );
                    refresh();
                    });
                 })(button2, cookieDate, response.users[i].userid, usersItems[j]);
                div.append(button2);
                }
                }
             //});
            
            $("#otherUsers").append(div);
          } 

        });
        $.get("/inventory/" + cookieDate,function (data) {
          if (data == undefined || data.length == 0) {
             $("#inventory").html("You are not carrying anything");
          } else {
             $("#inventory").html("You are carrying: ");
             for(var i in data) {
               var item = data[i];
               $("#inventory").append(item);
               button = $("<button/>");
               button.text("Drop " + item);
                (function(button,where,item) {
                  button.click(function() {
                    $.ajax("/" + where + "/" + item + "/" + cookieDate,
                        { success : refresh
                        , type : "PUT"
                        }
                    );
                    refresh();
                  });
                })(button,where,item);
               $("#inventory").append(button);
            }
          }
        });
      }, 500);

      //refresh();

    });
  </script>
  </body>
</html>
